<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <link href="./vendors/css/jquery-ui.css" rel="stylesheet"/>
    <link href="./vendors/css/jstree/style.min.css" rel="stylesheet" />
    <link href="./resources/css/rdc.css" rel="stylesheet" />
    <link href="./resources/css/kvot.css" rel="stylesheet" />  
    <script src="./vendors/js/jquery-1.8.3.js"></script>
    <script src="./vendors/js/jquery-ui-1.9.2.custom.js"></script>
    <script src="./vendors/js/jstree.min.js"></script>
    <script src="./resources/js/rndecaydata.js"></script>
    <script src="./resources/js/rndatatree.js"></script>
    <script src="./vendors/js/cytoscape.umd.js"></script>
    <script src="./resources/js/ndf.min.js"></script>
    <script src="./vendors/js/plotly-2.14.0.min.js"></script>
    <script src="./vendors/js/math.min.js"></script>
    <script src="./vendors/js/FileSaver.min.js"></script>
    <script src="./vendors/js/cytoscape-cxtmenu2.js"></script>
    <link href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css" rel="stylesheet" />
    <script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"></script>
    <title>Radionuclide decay chains (ICRP Publication 107)</title>
    <link rel="icon" type="image/x-icon" href="./resources/images/favicon.ico">
</head>
<body>

<header></header>

<div class="content">

    <!-- The Modal info view -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <div class="modal-top">
                <span class="close">&times;</span>
            </div>
            <br>
            <h3>Radionuclide decay chains</h3>
            <p>
                This webpage serves as a comprehensive tool for generating illustrations depicting radionuclide decay chains as defined in the <a href="https://www.icrp.org/publication.asp?id=ICRP%20Publication%20107" target="_blank" rel="noopener noreferrer" title="ICRP, 2008.">ICRP 2008</a>-database. Additionally, it offers the functionality to compute and visualize the temporal progression of radionuclide decay and ingrowth based on user-defined initial conditions. Users can access radionuclide-specific settings by right-clicking on a particular radionuclide within the chart.
            </p><p>
                The time evolution of radionuclide-specific characteristics can be displayed in a range of units including activity (measured in Becquerels, Bq), quantity (measured in moles), radiotoxicity upon ingestion (measured in Sieverts, Sv), external radiotoxicity (measured in Sv/(s m3)), and energy (measured in Mega-electronvolts, MeV). Furthermore, users can opt to view the total energy emitted or analyze it separately according to alpha emissions, electron emissions (including beta emissions), or photon emissions.
            </p><p>
                Conversion coefficients utilized to convert radionuclide activity (measured in Bq) to radiotoxicity upon ingestion (measured in Sv) for adults are sourced from the <a href="https://www.icrp.org/publication.asp?id=icrp%20publication%2072" target="_blank" rel="noopener noreferrer" title="ICRP, 1995.">ICRP 1995</a> guidelines. Similarly, conversion coefficients employed to convert radionuclide activity (measured in Bq) to external radiotoxicity (measured in Sv/(s m3)) in an infinite soil environment are drawn from the <a href="https://www.epa.gov/radiation/federal-guidance-report-no-15-external-exposure-radionuclides-air-water-and-soil" target="_blank" rel="noopener noreferrer" title="EPA, 2019.">EPA 2019</a> recommendations.
            </p><p>
                The <a href="https://www.icrp.org/publication.asp?id=ICRP%20Publication%20107" target="_blank" rel="noopener noreferrer" title="ICRP, 2008.">ICRP 2008</a>-database comprises comprehensive data on 1252 radionuclides across 97 elements, encompassing details such as half-lives, decay chains, and the yields and energies of emitted radiations resulting from nuclear transformations. The selection of nuclides for inclusion in the database was contingent on their half-life exceeding 1 minute or if they were formed as a byproduct in the nuclear transformation of a designated radionuclide. Notably, N-16, with a half-life of 7.13 seconds, was included primarily for historical significance. It is imperative that the underlying nuclear physics data be sufficiently robust to enable meaningful computations of radiation yields and energies.
            </p><p>
                The database contains compiled information for 922 radionuclides with half-lives surpassing 10 minutes, as well as 330 radionuclides with half-lives less than 10 minutes. Data pertaining to the 118 chemical elements within the periodic table are predominantly sourced from the <a href="https://pubchem.ncbi.nlm.nih.gov/periodic-table/" target="_blank" rel="noopener noreferrer" title="PubChem, 2023.">National Center for Biotechnology Information</a> as of 2023.
            </p>
            <h3>Glossary</h3>
            <p><b>Activity</b><br>
            The activity of a radionuclide expresses the number of transformations over a certain time interval. Its unit is 1 Becquerel (Bq), which represents an activity equal to one conversion per second.</p>
            <p><b>Alpha decay</b><br>
            In alpha decay, the nucleus of an atom of atomic number Z and mass number A emits an alpha particle (<sup>4</sup>He nucleus) to form an atom of atomic number Z - 2 and mass number A - 4.</p>
            <p><b>Auger transition</b><br>
            The filling of a vacancy in an inner electron shell of an atom, e.g. as created in electron capture, is accompanied by the emission of an electron from the outer shell, an Auger electron.</p>
            <p><b>Beta-minus decay</b><br>
            In beta-minus decay, the nucleus of an atom of atomic number Z and mass number A emits a negative electron (&beta;<sup>-</sup>) and an antineutrino (<span style="font-style: italic;text-decoration: overline;">v</span>) to form an atom of atomic number Z + 1 and mass number A.</p>
            <p><b>Beta-plus decay</b><br>
            In beta-plus decay, the nucleus of an atom of atomic number Z and mass number A emits a positive electron (&beta;<sup>+</sup>, positron) and a neutrino (<i>v</i>) to form an atom of atomic number Z - 1 and mass number A.</p>
            <p><b>Branching fraction</b><br>
            Branching fraction is the fraction of the nuclear transformations of the radionuclide that forms a particular daughter nucleus.</p>
            <p><b>Coster-Kronig (CK) transition</b><br>
            CK transition is an Auger transition in which the atomic shell vacancy is filled by an electron from a higher subshell of the same shell.</p>
            <p><b>Inner bremsstrahlung</b><br>
            Inner bremsstrahlung is a continuous electromagnetic radiation produced by the sudden change of nuclear charge which occurs in beta-plus, beta-minus, or electron-capture decay. This radiation is not included here because of its low energy and low yield.</p>
            <p><b>Electron-capture decay</b><br>
            In electron-capture decay, the nucleus of an atom of atomic number Z and mass number A captures an atomic electron and emits a neutrino (<i>v</i>) to form an atom of atomic number Z - 1 and mass number A.</p>
            <p><b>Half-life (T<sub>1/2</sub>)</b><br>
            The half-life of a radionuclide is the interval required for its activity to decay to half of its initial value. The half-life is related to the decay constant &lambda; as T<sub>1/2</sub> = ln(2)/&lambda; and to the mean life &tau; as &tau; = T<sub>1/2</sub>/ln(2).</p>
            <p><b>Gamma ray</b><br>
            Gamma-rays are electromagnetic radiations (photons) emitted by the nucleus in transition from a high energy state to a lower energy state.</p>
            <p><b>Isomeric transition decay</b><br>
            A nucleus in an excited energy state of an atom of atomic number Z and mass number A can transition to a lower energy state by emission of a gamma ray, or eject an orbital electron with the excess energy. No change in atomic and mass numbers occurs; the parent and daughter nuclei are isomers. Isomers of energy above the ground state are identified by appending 'm', 'n', 'p', or 'q' to the mass number.</p>
            <p><b>Isomers</b><br>
            Nuclei of the same atomic number Z and mass number A but with a different energy state and different physical half-life. Isomers of energy above the ground state are identified by appending 'm', 'n', 'p', or 'q' to the mass number.</p>
            <p><b>Internal conversion electron</b><br>
            An internal conversion electron is an orbital electron ejected from the atom as a result of the energy difference between states of the nucleus being transferred directly to a bound atomic electron. This process is a form of isomeric decay.</p>
            <p><b>Mole</b><br>
            The mole (symbol mol) is the unit of measurement for amount of substance, a quantity proportional to the number of elementary entities of a substance. One mole contains exactly 6.02214076&#215;10<sup>23</sup> elementary entities.</p>
            <p><b>Nuclear transformation</b><br>
            Nuclear transformation is the occurrence of the decay process(es) that spontaneously transform(s) an atom from one state to another. It is often referred to as 'decay' and its SI unit is the becquerel.</p>
            <p><b>Spontaneous fission</b><br>
            Spontaneous fission is a decay mechanism resulting in splitting of the nucleus into lighter nuclei, referred to as 'fission fragments', with the emission of neutrons.</p>
            <p><b>Transition</b><br>
            The individual process by which a nucleus is spontaneously transformed to another energy state.</p>
            <p><b>X ray</b><br>
            The filling of a vacancy in an inner electron shell of an atom, e.g. created in electron capture, may be accompanied by the emission of an x-ray photon.</p>
        
            <h3>References</h3>
            <a href="https://www.icrp.org/publication.asp?id=ICRP%20Publication%20107" target="_blank" rel="noopener noreferrer" title="ICRP, 2008.">ICRP, 2008</a>. <i>Nuclear Decay Data for Dosimetric Calculations</i>. ICRP Publication 107. Ann. ICRP 38 (3). <a href="https://journals.sagepub.com/doi/pdf/10.1177/ANIB_38_3" target="_blank" rel="noopener noreferrer" title="ICRP, 2008.">PDF</a><br>
            <a href="https://www.icrp.org/publication.asp?id=ICRP%20Publication%20107" target="_blank" rel="noopener noreferrer" title="ICRP, 1995.">ICRP, 1995</a>. <i>Age-dependent Doses to the Members of the Public from Intake of Radionuclides - Part 5 Compilation of Ingestion and Inhalation Coefficients</i>. ICRP Publication 72. Ann. ICRP 26 (1). <a href="https://journals.sagepub.com/doi/pdf/10.1177/ANIB_26_1" target="_blank" rel="noopener noreferrer" title="ICRP, 1995.">PDF</a><br>
            <a href="https://www.epa.gov/radiation/federal-guidance-report-no-15-external-exposure-radionuclides-air-water-and-soil" target="_blank" rel="noopener noreferrer" title="EPA, 2019.">EPA, 2019</a>. <i>External Exposure to Radionuclides in Air, Water and Soil</i>. Federal Guidance Report No. 15. EPA-402-R-19-002, U.S. Environmental Protection Agency, Washington DC. <a href="https://www.epa.gov/sites/default/files/2019-08/documents/fgr_15_final_508_2019aug02.pdf" target="_blank" rel="noopener noreferrer" title="EPA, 2019.">PDF</a><br>
            <a href="https://pubchem.ncbi.nlm.nih.gov/periodic-table/" target="_blank" rel="noopener noreferrer" title="EPA, 2019.">National Center for Biotechnology Information, 2023</a>. <i>Periodic Table of Elements</i>. Retrieved September 20, 2023 from https://pubchem.ncbi.nlm.nih.gov/periodic-table/ <br>
        </div>
    </div>

    <div class="sort">
        <table width="100%"><tr>        
            <td rowspan="2"><div class="togglesort" onclick="togglesort()">
            <div class="circle"></div>
        </div></td>
        <td style="text-align:right;vertical-align:top;line-height:5px;"><div class="sorttext">&nbsp;</div></td>
        <td rowspan="2" style="font-size: 30px;">&darr;</td></tr>
        <tr>   
            <td style="text-align:right;">z</td>
        </tr></table>
    </div>

    <div id="map" style="display:block"></div>

    <nav>
        <div id="tree" class="demo1"></div>
    </nav>

    <div id="chartdialog" class="ui-state-active">	
        <div class="settings" id="settings">
            <select name="chartunit" id="chartunit" class="ui-state-default ui-corner-all" onChange="updateLevelICrunAndUpdateChart()">
                <option value="Bq">Activity (Bq)</option>
                <option value="Mole">Amount (mol)</option>
                <option value="DCC_ing">Radiotoxicity on ingestion (Sv)</option>
                <option value="DCC_ext">External radiotoxicity (Sv/s m3)</option>
                <option value="Alpha_energy">Energy of alpha emissions (MeV)</option>
                <option value="Electron_energy">Energy of electrons, including beta (MeV)</option>
                <option value="Photon_energy">Energy of photon emission (MeV)</option>
                <option value="Total_energy">Total energy (MeV)</option>
            </select>				
            <label id="timelabel" for="timeinput" class="ui-state-default ui-corner-all">Time
            <input id="timeinput" type="number" min="0" value="100" onchange="runAndUpdateChart()">
            <select name="timeunit" id="timeunit" onChange='runAndUpdateChart()'>
                <option value='second'>seconds</option>
                <option value='minute'>minutes</option>
                <option value='hour'>hours</option>
                <option value='day'>days</option>
                <option value='year' selected>years</option>
            </select></label>			
        </div>
    </div>

    <div id="cy"></div>	
    <div id="icdialog" style="display:none"><form><input type="number" min="0" style="z-index:10000;width:82%" name="ICBQ" value="0"> Bq<br><br>
        <input type="number" min="0" style="z-index:10000;width:82%" name="ICMOLE" value="0"> mol</form></div>
</div>

<div id="info"></div>
<div id="kvotmap"></div>
<footer></footer>

<script src="./resources/js/site.js"></script>
<script src="./resources/js/rdc.js"></script>
<script>
// ── Shared components ────────────────────────────────────────────────────────
KVOT.renderHeader('radionuclide decay chains <span style="font-size: 0.5em;">icrp publication 107</span>',
    '<input id="search-input" class="search-input" type="text" placeholder="Search radionuclide..." onfocusout="searchUnfocus(this)"/>');
KVOT.renderNav('rdc.html');

var extraFooterIcons = ' | ' +
    '<svg onClick="printCY()" class="smallsvg" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" viewBox="0 0 16 16"><title>print decay chain</title><path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/><path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1z"/></svg>' +
    '<svg class="smallsvg" title="help" id="myBtn" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="white" viewBox="0 0 512 512"><path d="M464 256A208 208 0 1 0 48 256a208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm169.8-90.7c7.9-22.3 29.1-37.3 52.8-37.3h58.3c34.9 0 63.1 28.3 63.1 63.1c0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6c-13.3 0-24-10.7-24-24V250.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1c0-8.4-6.8-15.1-15.1-15.1H222.6c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"/></svg>';
KVOT.renderFooter(extraFooterIcons);
KVOT.initMap('kvotmap');

// ── Sort toggle ──────────────────────────────────────────────────────────────
var Asort = false;
function togglesort() {
    var toggle = document.querySelector('.togglesort');
    var text = document.querySelector('.sorttext');
    Asort = !Asort;
    if (Asort) {
        toggle.classList.add('activesort');
        text.innerHTML = 'a';
    } else {
        toggle.classList.remove('activesort');
        text.innerHTML = '&nbsp;';
    }
    $('#tree').jstree(true).refresh();
}

// ── Theme helpers for Cytoscape ───────────────────────────────────────────────
function isDarkMode() {
    return document.documentElement.getAttribute('data-theme') === 'dark';
}
function cyEdgeColor()    { return isDarkMode() ? '#b8a898' : '#000'; }
function cyBgColor()      { return isDarkMode() ? '#2a221b' : 'white'; }
function cyNodeBgColor()  { return isDarkMode() ? '#2a221b' : 'white'; }
function cyTextColor()    { return isDarkMode() ? '#b8a898' : 'gray'; }
function cyTextBgColor()  { return isDarkMode() ? '#1a1410' : 'white'; }
function cyNodeTextColor(){ return isDarkMode() ? '#f3b87b' : 'black'; }
function cyLevelFill()    { return isDarkMode() ? '#5a4520' : '#FFF4A3'; }
function cyLevelStroke()  { return isDarkMode() ? '#5a4f42' : 'black'; }
function plotlyPaperBg()  { return isDarkMode() ? '#332b23' : 'rgb(253,254,255)'; }
function plotlyPlotBg()   { return isDarkMode() ? '#2a221b' : 'rgb(255,255,255)'; }
function plotlyFontColor(){ return isDarkMode() ? '#e8ddd0' : '#333'; }
function plotlyGridColor(){ return isDarkMode() ? '#5a4f42' : '#eee'; }
function plotlyLineColor(){ return isDarkMode() ? '#5a4f42' : '#bbb'; }

// ── Element icon helper (colored SVG data URIs for jstree) ─────────────────────
function makeElementIcon(color) {
    return 'data:image/svg+xml,' + encodeURIComponent(
        "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'>" +
        "<path fill='" + color + "' d='M338.3 214.9l49.7-58.4c-12.8-6.6-23.9-16-32.4-27.6l-49.7 58.4c-15.2-8.4-32.8-13.3-51.4-13.3-23.9 0-45.9 7.9-63.7 21.2l-21.4-18.6c-6.1 13.1-15.8 24.3-27.9 32.1l21 18.2c-9.2 15.7-14.5 34-14.5 53.5 0 19.8 5.4 38.3 14.9 54.2l-14.3 13c11.6 8.3 21.4 19.1 28.6 31.5l14.3-13c17.7 13 39.5 20.7 63 20.7 21.2 0 41-6.3 57.6-17l10.3 10.5c7.1-12.5 17.7-22.9 30.4-29.7l-10.2-10.5c11.6-17 18.4-37.6 18.4-59.7 0-24.7-8.5-47.5-22.7-65.6z'/>" +
        "<path fill='" + color + "' d='M172.2 410.5c-10-44.8-54.6-73.2-99.5-63.2-44.8 10-73.2 54.6-63.2 99.5C17.9 484.6 52.1 512 90.8 512c6.1 0 12.2-.7 18.1-2C153.8 500 182.2 455.4 172.2 410.5z'/>" +
        "<path fill='" + color + "' d='M442.8 390.6c-7.4-14.3-19.9-24.9-35.3-29.8-15.4-4.9-31.7-3.6-46.1 3.8-14.3 7.4-24.9 19.9-29.9 35.3-4.9 15.4-3.6 31.7 3.8 46.1 7.4 14.3 19.9 24.9 35.3 29.8 6 1.9 12.2 2.8 18.5 2.8 9.5 0 19-2.3 27.6-6.7C446.4 456.7 458.1 420.2 442.8 390.6z'/>" +
        "<path fill='" + color + "' d='M429.4 0c-41.4 0-75.1 33.7-75.1 75.1s33.7 75.1 75.1 75.1 75.1-33.7 75.1-75.1S470.8 0 429.4 0z'/>" +
        "<path fill='" + color + "' d='M99.7 84c-33.3 0-60.4 27.1-60.4 60.4s27.1 60.4 60.4 60.4 60.4-27.1 60.4-60.4S133 84 99.7 84z'/>" +
        "</svg>"
    );
}

// ── Cytoscape setup ──────────────────────────────────────────────────────────
var CY = cytoscape({
    container: document.getElementById("cy"),
    elements: [],
    style: [{
        selector: "node",
        style: {
            "background-image": function (element) {
                if (element.data("Z") === 0) {
                    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg"></svg>');
                } else {
                    var txtCol = cyNodeTextColor();
                    var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="10em" height="10em">';
                    if (element.data("level") > 0) {
                        var level = 10 - element.data("level") * 10;
                        svg = svg + '<rect x="0em" y="' + level + 'em" width="10em" height="10em" stroke="' + cyLevelStroke() + '" fill="' + cyLevelFill() + '" stroke-width=".05em" />';
                    }
                    svg = svg + '<foreignObject x="0" y="1em" width="10em" height="10em">' +
                        '<body xmlns="http://www.w3.org/1999/xhtml">' +
                        '<table style="border-spacing:0px;padding:0px;font-family:helvetica neue,helvetica,liberation sans,arial,sans-serif;margin-left:auto; margin-right: auto;color:' + txtCol + ';">' +
                        '<tr><td valign="bottom" align="right" style="font-size:1.4em;">' + element.data('A') + "" + element.data('state') + '</td>' +
                        '<td rowspan="2" style="font-size:4em;text-align:left;"><b>' + element.data('Element') + '</b></td></tr>' +
                        '<tr><td valign="top" align="right" style="font-size:1.4em;">' + element.data('Z') + '</td></tr>' +
                        '<tr><td colspan="2" style="font-size:1.5em;text-align:center;">' + element.data('Halflife') + '</td></tr></table>' +
                        '</body>' +
                        '</foreignObject>';
                    svg = svg + '</svg>';
                    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
                }
            },
            "overlay-opacity": 0,
            "background-fit": "cover cover",
            "background-color": function(element) { return element.data('Z') === 0 ? cyTextBgColor() : cyNodeBgColor(); },
            "border-color": function(element) { return element.data('Z') === 0 ? cyTextBgColor() : cyEdgeColor(); },
            "border-width": function (element) {
                if (element.data("Z") === 0) { return 0; } else { return 2; }
            },
            height: function (element) {
                if (element.data("Z") === 0) { return 10; } else { return 80; }
            },
            width: function (element) {
                if (element.data("Z") === 0) { return 10; } else { return 80; }
            },
        }
    }, {
        selector: "edge",
        style: {
            width: 1,
            "overlay-opacity": 0,
            "line-color": function(element) { return cyEdgeColor(); },
            "target-arrow-color": function(element) { return cyEdgeColor(); },
            "target-arrow-shape": "triangle",
            "curve-style": "bezier",
            "font-family": "sans-serif",
            'color': function(element) { return cyTextColor(); },
            'font-size': '10px',
            'text-background-color': function() { return cyTextBgColor(); },
            'text-background-shape': 'rectangle',
            'text-background-opacity': '1',
            "text-wrap": "wrap",
            "label": function (element) {
                return element.data('mode').replace("&beta;", "\u03B2").replace("&alpha;", "\u03B1") + "\n" + element.data("br");
            },
            "line-style": function (element) {
                if (element.data("mode") === "SF") { return "dashed"; } else { return "solid"; }
            },
        }
    }],
    minZoom: 0.5,
    maxZoom: 2,
    wheelSensitivity: 0.2,
});

function styleBorder(rn, onoff) {
    var node = CY.getElementById(rn);
    // SF nodes stay invisible — never restyle them
    if (node.data('Z') === 0) return;
    if (onoff) {
        var linesCY = ['solid','dashed','dotted','double'];
        node.style('border-color', "rgb("+node.data().color[0]+","+node[0].data().color[1]+","+node[0].data().color[2]+")");
        node.style('border-style', linesCY[LINES.indexOf(node.data().dash)]);
        node.style('border-width', 2);
        node.style('background-color', "rgb("+node.data().color[0]+","+node[0].data().color[1]+","+node[0].data().color[2]+")");
        node.style('background-opacity','0.2');
    } else {
        node.style('border-color', cyEdgeColor());
        node.style('border-style', 'solid');
        node.style('border-width', 1);
        node.style('background-color', cyNodeBgColor());
        node.style('background-opacity','1');
    }
}

// Update cytoscape when theme changes
new MutationObserver(function() {
    CY.style().update();
    // Reset all nodes to new theme colors
    CY.nodes().forEach(function(node) {
        if (node.data('Z') === 0) {
            // SF nodes stay invisible
            node.style('background-color', cyTextBgColor());
            node.style('border-color', cyTextBgColor());
        } else {
            node.style('border-color', cyEdgeColor());
            node.style('background-color', cyNodeBgColor());
        }
    });
    // Update Plotly chart colors on theme change
    if (CHARTDIALOG && CHARTDIALOG[0] && CHARTDIALOG[0].data) {
        Plotly.relayout(CHARTDIALOG[0], {
            paper_bgcolor: plotlyPaperBg(),
            plot_bgcolor: plotlyPlotBg(),
            'font.color': plotlyFontColor(),
            'xaxis.gridcolor': plotlyGridColor(),
            'xaxis.linecolor': plotlyLineColor(),
            'xaxis.tickfont.color': plotlyFontColor(),
            'xaxis.titlefont.color': plotlyFontColor(),
            'yaxis.gridcolor': plotlyGridColor(),
            'yaxis.linecolor': plotlyLineColor(),
            'yaxis.tickfont.color': plotlyFontColor(),
            'yaxis.titlefont.color': plotlyFontColor(),
        });
    }
}).observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });

CY.on('zoom', function (event) {});
CY.on('mouseover', 'node', function(e) { styleBorder(e.target.data().id, true); });
CY.on('mouseout', 'node', function(e) { styleBorder(e.target.data().id, false); });

function createSubmenuLineColorSelect() {
    var submenu = [];
    for (var i = 0; i < COLORS.length; i++) {
        submenu.push({
            fillColor: 'rgba('+COLORS[i][0]+', '+COLORS[i][1]+', '+COLORS[i][2]+', 0.75)',
            content: '',
            select: (function(idx) { return function (ele) {
                Plotly.restyle(CHARTDIALOG[0],{'line.color':'rgb('+COLORS[idx][0]+', '+COLORS[idx][1]+', '+COLORS[idx][2]+')'},ele.data().index);
                ele.data().color = COLORS[idx];
            }; })(i)
        });
    }
    return submenu;
}

function createSubmenuLineStyleSelect() {
    var submenu = [];
    for (var i = 0; i < LINES.length; i++) {
        submenu.push({
            content: LINES[i],
            select: (function(idx) { return function (ele) {
                Plotly.restyle(CHARTDIALOG[0],{'line.dash':LINES[idx]},ele.data().index);
                ele.data().dash = LINES[idx];
            }; })(i)
        });
    }
    return submenu;
}

CY.cxtmenu({
    selector: 'node[type='+TYPE_NUCLIDE+']',
    adaptativeNodeSpotlightRadius: true,
    menuRadius: 200,
    minSpotlightRadius: 1,
    maxSpotlightRadius: 100,
    itemTextShadowColor: 'black',
    commands: [
        {
            content: 'line-color',
            submenu: createSubmenuLineColorSelect(),
        },
        {
            content: 'line-style',
            submenu: createSubmenuLineStyleSelect(),
        },
        {
            content: 'initial inventory',
            submenu: [
                {	
                    content: 'clear inventory',
                    select: function (node) {
                        node.data().IC = 0;
                        updateLevel("IC");
                        runAndUpdateChart();
                    }
                },
                {	
                    content: '+1 Bq',
                    select: function (node) {
                        node.data().IC = node.data().IC + 1;
                        updateLevel("IC");
                        runAndUpdateChart();									
                    }
                },
                {	
                    content: '+1 mol',
                    select: function (node) {
                        node.data().IC = node.data().IC + Math.log(2)/getRn(node.data().id).Halflife_y*6.02214179E23/(60*60*24*365.242196);
                        updateLevel("IC");
                        runAndUpdateChart();									
                    }
                },
                {	
                    content: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="-1024 0 2536 512"><path fill="white" d="M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2c-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.3-28.2 18.9-44 25.4l-12.5 57.1c-2 9.1-9 16.3-18.2 17.8c-13.8 2.3-28 3.5-42.5 3.5s-28.7-1.2-42.5-3.5c-9.2-1.5-16.2-8.7-18.2-17.8l-12.5-57.1c-15.8-6.5-30.6-15.1-44-25.4L83.1 425.9c-8.8 2.8-18.6 .3-24.5-6.8c-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6c4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2c5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.3 28.2-18.9 44-25.4l12.5-57.1c2-9.1 9-16.3 18.2-17.8C227.3 1.2 241.5 0 256 0s28.7 1.2 42.5 3.5c9.2 1.5 16.2 8.7 18.2 17.8l12.5 57.1c15.8 6.5 30.6 15.1 44 25.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8c8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336c44.2 0 80-35.8 80-80s-35.8-80-80-80s-80 35.8-80 80s35.8 80 80 80z"/></svg>',
                    select: function (node) {
                        updateIC(node);
                    }
                },
            ]
        },
        {
            content: 'select as initial\nradionuclide',
            select: function (node) {
                $('#tree').jstree(true).show_all();
                $('#tree').jstree('search', node.id());
            }
        },
    ]
});

// ── Modal ────────────────────────────────────────────────────────────────────
var modal = document.getElementById("myModal");
var btn = document.getElementById("myBtn");
var span = document.getElementsByClassName("close")[0];

btn.onclick = function() { modal.style.display = "block"; };
span.onclick = function() { modal.style.display = "none"; };
window.onclick = function(event) {
    if (event.target == modal) { modal.style.display = "none"; }
};

window.onload = function() {
    $('#tree').jstree(true).show_all();
    $('#tree').jstree('select_node', 'U-238');
};

function selectElement(Z) {
    $('#tree').jstree(true).show_all();    
    $('#tree').jstree('select_node', datatree[Z].text);
}

// ── Decay graph ──────────────────────────────────────────────────────────────
function decaygraph(ids, rnnode) {
    if (rnnode.hasOwnProperty('Progenies')) {
        rnnode.Progenies.forEach(function (progeny) {
            var progname = progeny.name;
            if (!ids.includes(progname)) {
                if (progname == "SF") {
                    progname = progname + Math.random();
                    var pos = getPosition(rnnode);
                    CY.add({
                        data: {
                            id: progname, Halflife: "", Element: "", A: 0, Z: 0, state: 0, IC: 0,
                            level: 0, type: TYPE_SF, color: [255,255,255], dash: "dot",
                        },
                        position: { x: pos.x + 100, y: pos.y - 100 }
                    });
                } else {
                    var prognode = getRn(progname);
                    var pos = getPosition(prognode);
                    var type = TYPE_NUCLIDE;
                    nodeIndex = nodeIndex + 1;
                    var color = COLORS[nodeIndex % COLORS.length];
                    var dash = LINES[Math.floor(nodeIndex / COLORS.length)];
                    if (prognode.Halflife == "Stable") {
                        type = TYPE_STABLE;
                        nodeIndex = nodeIndex - 1;
                        color = [0,0,0];
                        dash = 'solid';
                    }
                    CY.add({
                        data: {
                            id: prognode.name, Halflife: prognode.Halflife, Element: prognode.Element,
                            A: prognode.A, Z: prognode.Z, state: prognode.state, IC: 0,
                            level: 0, type: type, color: color, dash: dash, index: nodeIndex,
                        },
                        position: { x: pos.x, y: pos.y },
                    });
                    ids[ids.length] = progname;
                    decaygraph(ids, getRn(progname));
                }
            }
            if (!(ids.includes(rnnode.name.concat(progname)))) {
                ids[ids.length] = rnnode.name.concat(progname);
                CY.add({
                    data: { mode: progeny.mode, br: formatBR(progeny.br), source: rnnode.name, target: progname },
                });
            }
        });
    }
}

function printCY() {
    var sel = $('#tree').jstree("get_selected",true)[0].text;
    if (sel.includes('-')) {
        var blob = CY.png({'bg':'#FFF','full':true,'output':'blob'});
        saveAs(blob, sel+'.png');
    } else {
        console.log('No radionuclide selected');
    }
}

function updateLevel(state, rns, y) {
    if (state === "IC") {
        rns = CY.nodes().filter(function (node) {
            if (node.data().Halflife == "Stable" || node.id().startsWith("SF")) {
                return false;
            } else {
                return true;
            }
        }).map(function(x) { return x.id(); });
        var unit = document.getElementById("chartunit").value;
        var n = rns.length;
        y = new Array(n);
        var totact = 0;
        for (var i = 0; i < n; i++) {            
            var rn = rns[i];
            var node = CY.getElementById(rn);
            var ic = node.data().IC;
            var multfac = 1;
            if (unit !== "Bq") {
                var rnnode = getRn(rn);
                if (unit === "Total_energy") {
                    multfac = rnnode["Alpha_energy"] + rnnode["Electron_energy"] + rnnode["Photon_energy"];
                } else if (unit === "Mole") {
                    multfac = 60*60*24*365.242196*rnnode.Halflife_y/Math.log(2)/6.02214179E23;
                } else {
                    multfac = rnnode[unit];
                }
            }
            totact = totact + ic*multfac;
            y[i] = ic*multfac;
        }
        for (var i = 0; i < n; i++) {
            var node = CY.getElementById(rns[i]);
            if (totact == 0) {
                node.data().level = 0;
            } else {
                node.data().level = y[i]/totact;
            }
        }
    } else {
        var totact = 0;
        for (var i = 0; i < rns.length; i++) {
            totact = totact + y[i];
        }
        for (var i = 0; i < rns.length; i++) {
            var node = CY.getElementById(rns[i]);
            if (totact == 0) {
                node.data().level = 0;
            } else {
                node.data().level = y[i]/totact;
            }
        }
    }
    CY.nodes().select();
    CY.nodes().unselect();
}

function updateLevelICrunAndUpdateChart() {
    updateLevel("IC");
    runAndUpdateChart();
}

function updateIC(node) {
    $("#icdialog").dialog({
        title: "Set initial inventory for " + node.id(),
        modal: true,
        buttons: {
            'OK': function () {
                var IC = $('input[name="ICBQ"]').val();
                node.data().IC = Number(IC);
                updateLevel("IC");
                runAndUpdateChart();
                $(this).dialog('close');
            },
            'Cancel': function () {
                $(this).dialog('close');
            }
        },
        open: function (event, ui) {
            $('input[name="ICBQ"]').val(node.data().IC);
            $('input[name="ICMOLE"]').val(node.data().IC*60*60*24*365.242196*getRn(node.id()).Halflife_y/Math.log(2)/6.02214179E23);

            $('input[name="ICMOLE"]').change(function() {
                $('input[name="ICBQ"]').val(Number($('input[name="ICMOLE"]').val())/(60*60*24*365.242196*getRn(node.id()).Halflife_y/Math.log(2)/6.02214179E23));
            });
            $('input[name="ICBQ"]').change(function() {
                $('input[name="ICMOLE"]').val(Number($('input[name="ICBQ"]').val())*(60*60*24*365.242196*getRn(node.id()).Halflife_y/Math.log(2)/6.02214179E23));
            });
        }
    });
}

// ── jstree ───────────────────────────────────────────────────────────────────
var xrn;
var yrn;
var nodeIndex;

$('#tree').jstree({
    'core': {
        'multiple': false,
        'data': datatree
    },
    'types': {
        'Alkali_metal': { "icon": makeElementIcon("rgb(0,128,0)") },
        'Alkaline_earth_metal': { "icon": makeElementIcon("rgb(86,0,36)") },
        'Transition_metal': { "icon": makeElementIcon("rgb(98,50,236)") },
        'Post__transition_metal': { "icon": makeElementIcon("rgb(34,119,84)") },
        'Metalloid': { "icon": makeElementIcon("rgb(148,87,0)") },
        'Reactive_nonmetal': { "icon": makeElementIcon("rgb(0,96,240)") },
        'Noble_gas': { "icon": makeElementIcon("rgb(255,231,235)") },
        'Lanthanide': { "icon": makeElementIcon("rgb(0,51,85)") },
        'Actinide': { "icon": makeElementIcon("rgb(199,50,0)") },
        'Unknown_properties': { "icon": makeElementIcon("rgb(111,103,79)") },
        'isotope': { "icon": "isotope" },
        'radioisotope': { "icon": "radioisotope" }
    },
    plugins: ["search", "types", "themes", "sort"],
    "search": {
        "case_sensitive": false,
        "show_only_matches": false,
    },
    "sort": function (a, b) { 
        a1 = this.get_node(a);
        b1 = this.get_node(b);
        if (a1 && !a1.type.endsWith('isotope')) {
            if (Asort) {
                return (a1.text > b1.text) ? 1 : -1;
            } else {
                return (Number(a1.a_attr.Z) > Number(b1.a_attr.Z)) ? 1 : -1;
            }
        } else {
            return 1; 
        }
    },
}).on("changed.jstree", function (e, data) {
    $('#tree').jstree(true).show_all();
    $('#tree').jstree('search', "");
    var node = data.instance.get_node(data.selected[0]);
    CY.elements().remove();
    var infodiv = document.getElementById("info");

    if (node && node.type.endsWith('isotope')) {
        infodiv.classList.remove("show");
        var ids = [node.text];
        rnnode = getRn(node.text);
        xrn = (rnnode.A - rnnode.Z) * 100;
        yrn = rnnode.Z * 100;
        var x = 0;
        var y = 0;
        if (rnnode.state == "m") {
            y = -141.5;
        } else if (rnnode.state == "n") {
            y = 141.5;
        }
        nodeIndex = 0;
        CY.add({
            data: {
                id: rnnode.name, Halflife: rnnode.Halflife, Element: rnnode.Element,
                A: rnnode.A, Z: rnnode.Z, state: rnnode.state, IC: 0,
                level: 0, type: TYPE_NUCLIDE,
                color: COLORS[nodeIndex % COLORS.length],
                dash: LINES[Math.floor(nodeIndex / COLORS.length)],
                index: nodeIndex,
            },
            position: { x: x, y: y },
        });

        var unit = "year";
        var halflife = rnnode.Halflife_y;
        if (halflife > 1) {}
        else if (halflife * 365.25 > 1) { halflife *= 365.25; unit = "day"; }
        else if (halflife * 365.25 * 24 > 1) { halflife *= 365.25 * 24; unit = "hour"; }
        else if (halflife * 365.25 / 24 / 60 > 1) { halflife *= 365.25 * 24 * 60; unit = "minute"; }
        else { halflife *= 365.25 * 24 * 60 * 60; unit = "second"; }

        var expvalue = 1 + Math.ceil(Math.log10(halflife));
        document.getElementById("timeinput").value = "1e" + expvalue;
        document.getElementById("timeunit").value = unit;
        decaygraph(ids, rnnode);
        CY.ready(function () { CY.fit([], 20); });
    }
    else if (node) {
        var html = "";
        html=html+"<table border=0 style='font-size: 1.4em' cellpadding=0 cellspacing=0>";
        html=html+"<tr><td><b style='font-size: 2.5em'>"+node.a_attr.Z +"</b></td><td style='font-size: 2em'>"+node.a_attr.weight.replace('\u2013','') +"</td><td width='290' rowspan='4'>"+getPeriodicTable(node.a_attr.Z)+"</td></tr>";
        html=html+"<tr style='line-height: 5em;'><td colspan=2><b style='vertical-align:top;font-size:7em'>"+node.a_attr.symbol+"</b></td></tr>";
        html=html+"<tr><td style='vertical-align: bottom;padding-top:10px;font-size: 2em' colspan=2>"+node.text+"</td></tr>";
        html=html+"<tr><td style='vertical-align: bottom;font-size: 1.5em' colspan=2>"+node.a_attr.type+"</td></tr>";
        html=html+"<tr><td colspan=3>"+node.a_attr.info+"</td></tr>";
        html=html+"<tr><td colspan=3><br>Discovered "+node.a_attr.year +" by "+node.a_attr.discoverer +". "+node.a_attr.note +"<br><br></td></tr>";
        html=html+"<tr><th colspan=2>Origin of name</th><td>"+node.a_attr.origin_name +"</td></tr>";
        html=html+"<tr><th colspan=2>Atomic mass</th><td>"+node.a_attr.weight +" g/mol</td></tr>";
        html=html+"<tr><th colspan=2>Standard state</th><td class='"+node.a_attr.phase.replace(' (expected)','')+"'>"+node.a_attr.phase +"</td></tr>";
        html=html+"<tr><th colspan=2 style='vertical-align: bottom;'>Electron configuration</th><td>"+node.a_attr.electron +"</td></tr>";
        html=html+"<tr><th colspan=2>Oxidation states</th><td>"+node.a_attr.oxi +"</td></tr>";
        html=html+"<tr><th colspan=2>Electronegativity (Pauling scale)</th><td>"+node.a_attr.electro +"</td></tr>";
        html=html+"<tr><th colspan=2>Atomic radius (van der Waals)</th><td>"+node.a_attr.radius +" pm</td></tr>";
        html=html+"<tr><th colspan=2>Ionization energy</th><td>"+node.a_attr.ion +" eV</td></tr>";
        html=html+"<tr><th colspan=2>Electron affinity</th><td>"+node.a_attr.affin +" eV</td></tr>";
        html=html+"<tr><th colspan=2>Melting point</th><td>"+node.a_attr.melting +"\u00B0C</td></tr>";
        html=html+"<tr><th colspan=2>Boiling point</th><td>"+node.a_attr.boiling +"\u00B0C</td></tr>";
        html=html+"<tr><th colspan=2>Specific heat capacity</th><td>"+node.a_attr.heat +" J/g \u00B7 K</td></tr>";
        html=html+"<tr><th colspan=2 style='vertical-align: bottom;'>Density</th><td>"+node.a_attr.density +" g/cm<sup>3</sup></td></tr>";
        html=html+"<tr><th colspan=2>Earth</th><td>"+node.a_attr.earth +"%</td></tr>";
        html=html+"<tr><th colspan=2>Abundance in the Earth's crust</th><td>"+node.a_attr.abundance +" mg/kg</td></tr>";
        html=html+"<tr><th colspan=2>Block</th><td>"+node.a_attr.block+"</td></tr>";
        html=html+"<tr><th colspan=2>Origin</th><td>"+node.a_attr.origin +"</td></tr>";
        html=html+"</table>";
        infodiv.innerHTML = html;

        infodiv.classList.remove("Alkali_metal");
        infodiv.classList.remove("Alkaline_earth_metal");
        infodiv.classList.remove("Transition_metal");
        infodiv.classList.remove("Post__transition_metal");
        infodiv.classList.remove("Metalloid");
        infodiv.classList.remove("Reactive_nonmetal");
        infodiv.classList.remove("Noble_gas");
        infodiv.classList.remove("Lanthanide");
        infodiv.classList.remove("Actinide");
        infodiv.classList.remove("Unknown_properties");
        infodiv.classList.add(node.type);
        infodiv.classList.add("show");
    }
    runAndUpdateChart();
}).on('search.jstree', function (nodes, data, res) {
    data.instance.deselect_all();
    data.instance.close_all();
    if (data.nodes.length === 0) {
        $('#tree').jstree(true).hide_all();
    } else if (data.nodes.length > 0) {
        data.instance.select_node(data.res[0]);
    }
}).on('loaded.jstree', function(e, data) {
    $('#tree').jstree('search', 'U-238');
});

// ── Chart ────────────────────────────────────────────────────────────────────
function runAndUpdateChart() {
    var order = CY.nodes().filter(function (node) {
        if (node.data().Halflife == "Stable" || node.id().startsWith("SF")) {
            return false;
        } else {
            return true;
        }
    }).map(function(x) { return x.id(); });
    var n = order.length;
    var y0 = new Array(n);
    var lambda = new Array(n);
    var dydt_data = new Array(n);
    var currns = new Array(n);
    var totact = 0;
    for (var i = 0; i < n; i++) {
        var rn = order[i];
        var node = CY.getElementById(rn);
        var ic = node.data().IC;
        totact = totact + ic;
        currns[i] = getRn(rn);
        lambda[i] = Math.log(2) / currns[i].Halflife_y;
        y0[i] = ic;
        dydt_data[i] = new Array();
    }
    if (totact === 0) {
        if (CHARTDIALOG.dialog("isOpen")) { CHARTDIALOG.dialog("close"); }
        return;
    } else if (!CHARTDIALOG.dialog("isOpen")) {
        CHARTDIALOG.dialog("open");
    }
    for (var i = 0; i < n; i++) {
        for (var j = 0; j < currns[i].Progenies.length; j++) {
            var pos = order.indexOf(currns[i].Progenies[j].name);
            if (pos > -1) {
                dydt_data[pos][dydt_data[pos].length] = {
                    br: Number(currns[i].Progenies[j].br),
                    index: i
                };
            }
        }
    }
    var timeunit = "year";
    var yaxistitle = "Activity (Bq)";
    var data = new Array(n);
    if (n > 0) {
        var endtime = Number(document.getElementById("timeinput").value);
        timeunit = document.getElementById("timeunit").value;
        var timescale = 1;
        switch (timeunit) {
            case "second": timescale /= 60;
            case "minute": timescale /= 60;
            case "hour": timescale /= 24;
            case "day": timescale /= 365.25;
            case "year":
        }
        var tspan = [0, endtime * timescale];
        var Jacobian = new Array(n);
        for (var i = 0; i < n; i++) {
            Jacobian[i] = new Array(n).fill(0);
            Jacobian[i][i] = -lambda[i];
        }
        for (var i = 0; i < n; i++) {
            for (var j = 0; j < dydt_data[i].length; j++) {
                Jacobian[i][dydt_data[i][j].index] += dydt_data[i][j].br*lambda[i];
            }
        }
        var result = ndf(function(t, y) {
            var dydt = new Array(n);
            for (var i = 0; i < n; i++) {
                dydt[i] = -y[i];
                for (var j = 0; j < dydt_data[i].length; j++) {
                    dydt[i] += dydt_data[i][j].br * y[dydt_data[i][j].index];
                }
                dydt[i] *= lambda[i];
            }
            return dydt;
        }, tspan, y0, {
            Refine: 4,
            AbsTol: 1e-20,
            RelTol: 1e-6,
            Jacobian: Jacobian
        });
        var tout = result.tout;
        var yout = result.yout;
        tout = tout.map(function(x) { return x / timescale; });

        var sel = document.getElementById("chartunit");
        var unit = sel.value;
        yaxistitle = sel.options[sel.selectedIndex].text;
        var multfac = 1;
        for (var i = 0; i < n; i++) {
            var nodeEl = CY.nodes("#"+order[i]);
            if (unit !== "Bq") {
                var rnnode = getRn(order[i]);
                if (unit === "Total_energy") {
                    multfac = rnnode["Alpha_energy"] + rnnode["Electron_energy"] + rnnode["Photon_energy"];
                } else if (unit === "Mole") {
                    multfac = 60*60*24*365.242196*rnnode.Halflife_y/Math.log(2)/6.02214179E23;
                } else {
                    multfac = rnnode[unit];
                }
            }
            var yi = yout[i].map(function(x) { return x * multfac; });
            data[i] = {
                x: tout,
                y: yi,
                name: order[i],
                line: {
                    color: "rgb("+nodeEl.data().color[0]+","+nodeEl[0].data().color[1]+","+nodeEl[0].data().color[2]+")",
                    dash: nodeEl.data().dash,
                }
            };
        }
    }
    Plotly.newPlot(CHARTDIALOG[0], data, {
        autosize: true,
        paper_bgcolor: plotlyPaperBg(),
        plot_bgcolor: plotlyPlotBg(),
        margin: { t: 4, b: 70 },
        font: { color: plotlyFontColor() },
        yaxis: {
            title: yaxistitle,
            type: YAXISTYPE,
            mirror: true, ticks: 'outside', showline: true,
            linecolor: plotlyLineColor(),
            gridcolor: plotlyGridColor(),
            tickfont: { color: plotlyFontColor() },
            titlefont: { color: plotlyFontColor() },
        },
        xaxis: {
            title: 'Time (' + timeunit + 's)',
            type: XAXISTYPE,
            mirror: true, ticks: 'outside', showline: true,
            linecolor: plotlyLineColor(),
            gridcolor: plotlyGridColor(),
            tickfont: { color: plotlyFontColor() },
            titlefont: { color: plotlyFontColor() },
        },
    }, {
        displaylogo: false,
        responsive: true,
        toImageButtonOptions: {
            format: 'svg',
            filename: yaxistitle,
            height: 500, width: 700, scale: 1
        },
        modeBarButtonsToRemove: ['resetScale2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d'],
        modeBarButtonsToAdd: [{
            name: "downloadCsv",
            title: "Download data as csv",
            icon: Plotly.Icons.disk,
            click: function(gd) {
                var blobdata = ["Time (" + timeunit + ")"];
                for (var j = 0; j < n; j++) { blobdata[0] = blobdata[0] + "," + order[j]; }
                for (var i = 0; i < data[0].x.length; i++) {
                    blobdata[i + 1] = data[0].x[i];
                    for (var j = 0; j < n; j++) { blobdata[i + 1] = blobdata[i + 1] + "," + data[j].y[i]; }
                }
                var blob = new Blob([blobdata.join("\r\n")], { type: "text/csv" });
                saveAs(blob, gd.layout.yaxis.title.text + ".csv");
            },
        },{
            name: "linLogY",
            title: "Toggle linear/logarithmic "+yaxistitle+"-scale",
            icon: {
                width: 448, height: 512,
                path: 'M246.6 41.4c-12.5-12.5-32.8-12.5-45.3 0l-160 160c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L224 109.3 361.4 246.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3l-160-160zm160 352l-160-160c-12.5-12.5-32.8-12.5-45.3 0l-160 160c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L224 301.3 361.4 438.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3z'
            },
            click: function(gd) {
                if (gd.layout.yaxis.type === "linear") { YAXISTYPE = 'log'; } else { YAXISTYPE = 'linear'; }
                Plotly.relayout(CHARTDIALOG[0],{'yaxis.type': YAXISTYPE});            
            },
        },{
            name: "linLogX",
            title: "Toggle linear/logarithmic time-scale",
            icon: {
                width: 512, height: 512,
                path: 'M470.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L402.7 256 265.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l160-160zm-352 160l160-160c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L210.7 256 73.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0z'
            },
            click: function(gd) {
                if (gd.layout.xaxis.type === "linear") { XAXISTYPE = 'log'; } else { XAXISTYPE = 'linear'; }
                Plotly.relayout(CHARTDIALOG[0],{'xaxis.type': XAXISTYPE});             
            },
        }, 'togglespikelines', 'hoverclosest', 'hovercompare'],
        showEditInChartStudio: true,
        plotlyServerURL: "https://chart-studio.plotly.com",
    });
    
    Plotly.Plots.resize(CHARTDIALOG[0]);
    window.onresize = function () { Plotly.Plots.resize(CHARTDIALOG[0]); };

    CHARTDIALOG[0].on('plotly_hover', function (data) {
        var rn = data.points.map(function (d) { return d.data.name; });
        var y = data.points.map(function (d) { return d.y; });
        for (var i = 0; i < rn.length; i++) { styleBorder(rn[i], true); }
        if (rn.length > 1) { updateLevel("level", rn, y); } else { updateLevel("IC"); }
    }).on('plotly_unhover', function (data) {
        var rn = data.points.map(function (d) { return d.data.name; });
        for (var i = 0; i < rn.length; i++) { styleBorder(rn[i], false); }
        if (rn.length > 1) { updateLevel("IC"); }
    });
}
</script>
</body>
</html>
